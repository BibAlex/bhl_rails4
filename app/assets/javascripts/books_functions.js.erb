$(document).ready(function() {
    autocomplete();
    if( $('.tooltipname').length > 0 ){
      $('.tooltipname').tooltipster({ interactive: true, fixedWidth: 280});
    }
  });

function searchfnc(search_select, field){
	searchquery = '';
    if(field == null || field == '' ||  (/\S/.test(field) == false)){
      alert("<%= I18n.t('warn.empty_search_query_warn') %>");
      return;
    }
    
    if ([' ',  '!', '@', '#', '$' , '^', '&', '*', '(',  ',',  ')', '_',  '+', '-', '=' , '&', '%', '~'].indexOf(field) >= 0 || field.indexOf("%") >= 0) {
     alert("<%= I18n.t('warn.invalid_input') %>");
     return;
    }
    var url_parts = window.location.href.split('?');
    var path = url_parts[0];
    var type = search_select.options[search_select.selectedIndex].value;
      if(typeof url_parts[1] === 'undefined')
       {
         searchquery = "_" + type + "=" + field;
	   }
      else
      {
      	var params = url_parts[1].split('&');
      	var field_found = false;
      	for(var i = 0; i<params.length; i++)
      	{      		
      		var search_tokens = params[i].split('=');
      		if(search_tokens[0] === "_" + type)
      		{
      			params[i] = search_tokens[0] + "=" + search_tokens[1] + " _OR " + field;
      			field_found = true;  			
      		}
      		searchquery += params[i] + "&";
      		 			
      	}
      	searchquery = searchquery.substring(0, searchquery.length - 1);
      	if(field_found === false)
      		searchquery += "&_" + type + "=" + field;      	 
      }
      window.location = window.location.protocol + "//" + window.location.host + "/books" + "?" + searchquery;
  }
  
function autocomplete()
{	
    var cache;
    cache = {};
    return $("#headersearchfield").autocomplete({
      minLength: 2,
      source: function(request, response) {
        var term;
        term = request.term;
        if (term in cache) {
          response(cache[term]);
          return;
        }
        search_by = $("#headersearchby").val();
        if(search_by != "content" && search_by != "all")
        {
        	searchfield = $("#headersearchfield").val();
            return $.getJSON("/<%= I18n.locale %>/books/autocomplete?type=" + search_by, request, function(data, status, xhr) {
              cache[term] = data;
              return response(data);
            });
        }
        
      }
    }); 
}

function save_query(query)
{
	$.ajax({
	    url: "/user_search_history/save_query?query=" + encodeURIComponent(query),
	    type: "GET",        
	    success: function (data) { 
	      $("#flash").html(data);
	      document.getElementById( 'save_query' ).style.display = 'none';    
	    }
	  });
}

function loadformats(format){
    div_name = "#" + format.toLowerCase() + "_hidden";
    content = $(div_name).html();
    content = content.replace(/\n/g, '<br />'); // to convert \n to <br />
    if (format.toLowerCase() == "mods")
      content = content.replace(/\s/g, " &nbsp;");  // to display xml indentation
    $("#modallabel").html(format);
    $("#modalcontent").html(content);
}
